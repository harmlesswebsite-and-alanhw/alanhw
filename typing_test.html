<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0" />
      <script src="script.js"></script>
      <script src="https://harmlesswebsite.leoshi6.repl.co/library.js"></script>
      <link href="style.css" rel="stylesheet" type="text/css" />
    <meta name="description" content="Photoshopped Images by Paint" />
    <title>A Typing Night's Dream</title>
	<style>
	img {
		max-width: 100%;
	}
	img[src="Morone-St-PROFILE-PHOTO.png"] {
		width: 50%;
	}
	.big {
		font-size: 20px;
	}	
	iframe {
		border: none;
		overflow: hidden !important;
	}
	.small {
		font-size: 6px;
	}
	</style>
  </head>
    <body>
        <div>
        <i>Loading script (reload if it doesn't load in a few seconds)...</i>
        <button disabled="disabled" onclick="loadWord(); this.parentNode.hidden = 'hidden'; this.parentNode.nextElementSibling.hidden = '';">Start!</button>
        </div>
        <div id="game" hidden="hidden">
            <blockquote>
                                <button id="prev" onclick="loadWhere(where, globalThis.whereIndex - 1);">&lsaquo;</button>
                <span id="offset"></span> / <span id="total"></span>
                <button id="next" onclick="loadWhere(where, globalThis.whereIndex + 1);">&rsaquo;</button>
                <dl>
                    <dt style="font-weight: bold;">$PERSON</dt>
                    <dd style="white-space: pre-wrap;">$LINE</dd>
                </dl>
            </blockquote>
            <label>Type the missing word represented by the number of letters above:<br />
            <input id="word" style="box-sizing: border-box; width: 100%;" placeholder="Type this word" onkeydown="handleInput(event, this)" />
            </label>
            <div>(<span id="right">0</span> right, <span id="wrong">0</span> wrong, <span id="remaining">some</span> remaining until next shuffle)</div>
        </div>
        <script>
            function handleInput(ev, textbox) {
                if (ev.keyCode !== 13 && ev.keyCode !== 32) return;
                ev.preventDefault();
                const val = textbox.value.trim();
                if (val !== currentWord) document.getElementById('wrong').textContent = parseInt(document.getElementById('wrong').textContent) + 1;
                else document.getElementById('right').textContent = parseInt(document.getElementById('right').textContent) + 1;
                textbox.value = '';
                textbox.focus();
                loadWord();
            } 
            function loadWord() {
                document.getElementById('remaining').textContent = globalThis.things.length;
                document.getElementById('word').focus();
                if (!globalThis.things.length) globalThis.things = lib.shuffle(Object.keys(globalThis.words));
                const w = words[globalThis.things[0]];
                globalThis.currentWord = globalThis.things[0];
                globalThis.things.shift();
                globalThis.where = w.where;
                loadWhere(globalThis.where, 0);
            }
            function loadWhere(arr, index) {
                if (index >= arr.length) throw new DOMException('YOU ARE AN IDIOT');
                globalThis.whereIndex = index;
                document.getElementById('next').disabled = '';
                document.getElementById('prev').disabled = '';
                if (index - arr.length === -1) document.getElementById('next').disabled = 'disabled';
                if (!index) document.getElementById('prev').disabled = 'disabled';
                document.getElementById('total').textContent = arr.length;
                document.getElementById('offset').textContent = index + 1;
                const i = arr[index];
                const l = lines[i];
                document.querySelector('dt').textContent = l.person;
                const text = `\\b${lib.pregQuote(lib.escape(globalThis.currentWord))}\\b`;
                console.log(text);
                const regex = new RegExp(text, 'gi');
                document.querySelector('dd').innerHTML = lib.escape(l.line).replace(regex, function(text) {
                    console.log(text);
                    return `<mark>(${text.length})</mark>`;
                });
            }
            fetch(`https://hw-cdn.weeklyd3.repl.co/index.php?action=download&filename=bsiv-amnd`)
            .then(function(res) {
                return res.json();
            })
            .then(function(lines) {
                globalThis.words = {};
                globalThis.lines = lines;
                lines.forEach(function(line, i) {
                    globalThis.lineNum = i;
                    if (!line.person) return;
                    var line = line.line;
                    line = line.replace(/(\.|\?|\!|\,|\"|\;|:)/g, "");
                    line = line.toLowerCase();
                    line = line.replace(/ *\([^)]*\) */g, "");
                    line = line.replace(/  +/g, ' ');
                    // CALLBACK HELL
                    const moreLines = line.split("\n");
                    moreLines.forEach(function(actualLine) {
                        actualLine = actualLine.trim();
                        // З levels
                        // deep now.
                        // callbackhell.com
                        const splitWords = actualLine.split(" ");
                        splitWords.forEach(function(word) {
                            // Ч levels
                            // deep now
                            //
                            // The Pyramus
                            // of doom
                            if (globalThis.words[word]) if (globalThis.words[word].where.indexOf(lineNum) === -1) return globalThis.words[word].where.push(lineNum);
                            const w = {};
                            w.where = [lineNum];
                            globalThis.words[word] = w;
                        });
                    });
                });
                delete globalThis.words[""];
                globalThis.things = lib.shuffle(Object.keys(globalThis.words));
                document.querySelector('button').disabled = '';
            });
        </script>